---
title: "parent_analysis"
author: "Ellen Risemberg"
date: "2023-05-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/ellenrisemberg/Documents/ValdarFerris/Peanut_Crosses/backcross/")
```

## Load packages

```{r}
library(pzfx)
library(ICC)
library(MASS)
library(lme4)
source("/Users/ellenrisemberg/Documents/ValdarFerris/scripts/qtl_functions.R")
load_themes()
```

## Load data

```{r}
parentdata <- readr::read_csv("source_data/parent_challenge_data.csv")
parentige <- readr::read_csv("source_data/parent_PNsIgE.csv")[,c(1:3)]
parentdata <- as_tibble(parentdata)
```


--------------------------------------------------------------------------------
## Plot 
--------------------------------------------------------------------------------

Pivot data longer for plotting

```{r}
dat <- parentdata %>% 
  pivot_longer(cols = c('0', '15', '30', '45', '60'), names_to = 'Time', values_to = 'Temp')
```

Plot

```{r}
dark2cols <- brewer.pal(n = 5, name = 'Dark2')
# replacing #E58700 (orange) and blue with Dark2 colors 4 and 5 (cluster using 1-3)

pparent <- ggplot(dat, aes(x = Time, y = Temp)) +
  geom_line(aes(group = mouse_ID), color = c(rep(dark2cols[4], 50), rep(dark2cols[5], 45)), alpha=0.25, size=0.2) +
  stat_summary(aes(group = Strain, color = paste("mean", Strain)), fun.y = mean, geom="line", show.legend = TRUE) +
  stat_summary(aes(group = Strain, color = paste("mean", Strain)), fun.data = mean_se, geom = "errorbar", width=0.15) +
  scale_colour_manual('Strain', values = c(dark2cols[4:5]), labels = c('C3H/HeJ', 'CC027')) +
  labs(x = 'Minutes post-challenge', y = 'Body Temperature') +
  scale_x_discrete(expand = c(0.03,0.03)) +
  ylim(32.5, 40) 

# previously used this green - #00BA38

pparent
```

Save

```{r}
png('figs/parents/parent-temps.png', width = 600, height = 400)
pparent + big_theme
dev.off()

# save R object 
save(pparent, file = 'derived_data/other_Robjects/pparent.Rdata')
```



--------------------------------------------------------------------------------
## Compare temperature trajectories in CC0027 vs C3H 
--------------------------------------------------------------------------------

```{r}
parentdata$Strain <- factor(parentdata$Strain) # convert strain to factor 
```

Find average/sd of temps at each time point (for both CC027 and C3H mice)

```{r}
dat %>% 
  group_by(Time) %>%
  get_summary_stats(Temp, type = 'mean_sd')
```

Identify outliers

```{r}
dat %>% group_by(Time) %>%
  identify_outliers(Temp) # no extreme outliers
```

C3H mouse who has a significant drop is an outlier but not extreme.

--------------------------------------------------------------------------------
## Calculate derived measures    
--------------------------------------------------------------------------------

AAC statistic 

```{r}
parentdata$Temp_aac <- rep(NA, nrow(parentdata))
x <- c(0,15,30,45,60)

for (i in 1:nrow(parentdata)){
  line <- parentdata[i,c('0','15','30','45','60')]
  auc <- auc(x = x, y = line)
  aac <- line[1]*tail(x, n=1) - auc
  parentdata[i, 'Temp_aac'] <- as.numeric(aac)
}
```

Minimum temperature 

```{r}
parentdata$Min_Temp <- rep(NA, nrow(parentdata))
parentdata$Min_Temp <- apply(parentdata[,c('0','15','30','45','60')], 1, FUN=min)
```

Time of minimum temperature 

```{r}
parentdata$Min_Temp_Time <- rep(NA, nrow(parentdata))

for (i in 1:nrow(parentdata)){
  parentdata$Min_Temp_Time[i] <- as.numeric(names(which.min(parentdata[i,c('0', '15', '30', '45', '60')])))
}
```

Doesn't make sense to cluster parent data because we only see the tri-modal distribution in the backcross mice. 

Save unnormalized dataframe with derived measures:

```{r}
write_csv(parentdata, file = 'derived_data/parentdata.csv')
```


--------------------------------------------------------------------------------
## Means/ranges in parent strains   
--------------------------------------------------------------------------------

In CC027 inbreds:

```{r}
print('Temp at 0 min')
mean(parentdata$`0`[which(parentdata$Strain == 'CC027')])
range(parentdata$`0`[which(parentdata$Strain == 'CC027')])
print('Temp at 15 min')
mean(parentdata$`15`[which(parentdata$Strain == 'CC027')])
range(parentdata$`15`[which(parentdata$Strain == 'CC027')])
print('Temp at 30 min')
mean(parentdata$`30`[which(parentdata$Strain == 'CC027')])
range(parentdata$`30`[which(parentdata$Strain == 'CC027')])
print('Temp at 45 min')
mean(parentdata$`45`[which(parentdata$Strain == 'CC027')])
range(parentdata$`45`[which(parentdata$Strain == 'CC027')])
print('Temp at 60 min')
mean(parentdata$`60`[which(parentdata$Strain == 'CC027')])
range(parentdata$`60`[which(parentdata$Strain == 'CC027')])
print('Temp-AAC')
mean(parentdata$Temp_aac[which(parentdata$Strain == 'CC027')])
range(parentdata$Temp_aac[which(parentdata$Strain == 'CC027')])
print('Minimum temp')
mean(parentdata$Min_Temp[which(parentdata$Strain == 'CC027')])
range(parentdata$Min_Temp[which(parentdata$Strain == 'CC027')])
print('Time of minimum temp')
mean(parentdata$Min_Temp_Time[which(parentdata$Strain == 'CC027')])
range(parentdata$Min_Temp_Time[which(parentdata$Strain == 'CC027')])
```

In C3H inbreds:

```{r}
print('Temp at 0 min')
mean(parentdata$`0`[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$`0`[which(parentdata$Strain == 'C3H/HeJ')])
print('Temp at 15 min')
mean(parentdata$`15`[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$`15`[which(parentdata$Strain == 'C3H/HeJ')])
print('Temp at 30 min')
mean(parentdata$`30`[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$`30`[which(parentdata$Strain == 'C3H/HeJ')])
print('Temp at 45 min')
mean(parentdata$`45`[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$`45`[which(parentdata$Strain == 'C3H/HeJ')])
print('Temp at 60 min')
mean(parentdata$`60`[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$`60`[which(parentdata$Strain == 'C3H/HeJ')])
print('Temp-AAC')
mean(parentdata$Temp_aac[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$Temp_aac[which(parentdata$Strain == 'C3H/HeJ')])
print('Minimum temp')
mean(parentdata$Min_Temp[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$Min_Temp[which(parentdata$Strain == 'C3H/HeJ')])
print('Time of minimum temp')
mean(parentdata$Min_Temp_Time[which(parentdata$Strain == 'C3H/HeJ')])
range(parentdata$Min_Temp_Time[which(parentdata$Strain == 'C3H/HeJ')])
```


--------------------------------------------------------------------------------
## Normalize    
--------------------------------------------------------------------------------

Test for normality with Shapiro-Wilks test. Null hypothesis = data are normally distributed, so p < 0.05 means the data are not normally distributed.

```{r}
apply(parentdata[,c(4:11)], 2, FUN = shapiro.test)
```

Only baseline temp is normally distributed with high confidence. 

Normalize other phenotypes: 

```{r}
rawparentdata <- parentdata # save raw phenotypes 
# normalize all temp data except for min temp time (categorical)
parentdata[,c(4:11)] <- apply(parentdata[,c(4:11)], MARGIN = 2, FUN = trint)
```

Perform **one-way repeated-measures ANOVA** on the transformed temperature data (just temp @ baseline, 15 min, 30 min, 45 min and 60 min)

```{r}
# replace dat df with transformed data 
dat <- parentdata %>% 
  pivot_longer(cols = c('0', '15', '30', '45', '60'), names_to = 'Time', values_to = 'Temp')

res.aov <- aov(Temp ~ Strain + Time + Error(mouse_ID), data = dat)
summary(res.aov)
```


--------------------------------------------------------------------------------
## Calculate heritability  
--------------------------------------------------------------------------------

Rename time columns:

```{r}
names(parentdata)[4:8] <- c('T0', 'T15', 'T30', 'T45', 'T60')
```

Calculate $h^2$ for all normal phenotypes using $\frac{FSS}{TSS}$

```{r}
heritability <- data.frame(pheno = names(parentdata)[4:11], h2 = rep(NA, 8))

for (i in 1:nrow(heritability)){
  pheno <- heritability$pheno[i]
  
  if ((pheno == 'T0') | (pheno == 'Min_Temp_Time')){
    form <- paste(pheno, ' ~ Strain')
  } else {
    form <- paste0(pheno, ' ~ T0 + Strain')
  }
  
  aov <- anova(lm(form, parentdata))
  
  if ((pheno == 'T0') | (pheno == 'Min_Temp_Time')){
    heritability$h2[i] <- aov$`Sum Sq`[1] / sum(aov$`Sum Sq`) # 1st row = strain
  } else {
    heritability$h2[i] <- aov$`Sum Sq`[2] / sum(aov$`Sum Sq`) # 1st row = T0, 2nd row = strain
  }
  
}

heritability
```

Calculate heritability for IgE:

```{r}
parentige <- parentige[which(parentige$`Pre/post` == 'Post-sensitization'),]
parentige <- parentige[,-c(2)]

aov <- anova(lm(Value ~ Strain, data = parentige))

h2ige <- aov$`Sum Sq`[1] / sum(aov$`Sum Sq`) # 1st row = strain
h2ige
```

Means/ranges for IgE:

```{r}
mean(parentige$Value[which(parentige$Strain == 'C3H/HeJ')])
range(parentige$Value[which(parentige$Strain == 'C3H/HeJ')])
```

```{r}
mean(parentige$Value[which(parentige$Strain == 'CC027')])
range(parentige$Value[which(parentige$Strain == 'CC027')])
```










--------------------------------------------------------------------------------
Code not used, for posterity. 
--------------------------------------------------------------------------------

Calculate heritability for `Min_Temp_Time` (ordinal categorical) using *proportional odds logistic regression*:

```{r}
parentdata$Min_Temp_Time <- as.factor(parentdata$Min_Temp_Time)
mod <- polr(Min_Temp_Time ~ Strain, parentdata, Hess = TRUE)
```


Using LMM, which is incorrect bc the variance component $\sigma^2_\alpha$ from the strain random effectcannot be reliably estimated with only two strains. 

```{r}
# Calculate "by hand" (w/ LMM - incorrect)
# res <- lmer(Temp_0min ~ (1|Strain), challenge)
# vc <- as.data.frame(VarCorr(res))
# strainvar <- vc[vc$grp == 'Strain', 'vcov']
# resvar <- vc[vc$grp == 'Residual', 'vcov']
# icc <- strainvar/(resvar + strainvar)
```

Using random formula from [this lab exercise](https://www.ou.edu/journals/dis/DIS98/Teaching/Possideute%20&%20McQuade.pdf), which seems to produce inaccurate results. 

```{r}
# Calculate "by hand" with formula
# t0_CC027 <- challenge$Temp_0min[which(challenge$Strain == 'CC027')]
# t0_C3H <- challenge$Temp_0min[which(challenge$Strain == 'C3H/HeJ')]
# t0_h2 <- 0.5*((mean(t0_CC027) - mean(t0_C3H))/2)^2 / var(challenge$Temp_0min)
# t0_h2
```

Using `ICC:ICCbare`. This might be ok but idk what it's doing. Can be used on unbalanced datasets. 

```{r}
ICCbare(Strain, Temp_0min, data = challenge) # -0.12
ICCbare(Strain, Temp_15min, data = challenge) # 0.76
```





